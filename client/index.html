<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Peaple - Video Chat</title>
  <!-- ad -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7220479975152766"
     crossorigin="anonymous"></script>

<script>
// Fullscreen toggle logic for Video Call
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const fsBtn = document.getElementById('videoFullscreenBtn');
    const container = document.getElementById('videoContainer');
    const hint = document.getElementById('fsHint');
    const body = document.body;

    if (!fsBtn || !container) return;
    const fsToolbar = document.getElementById('fsToolbar');
    const callTools = document.querySelector('.call-tools');
    // FS toolbar buttons
    const fsStartBtn = document.getElementById('fsStartBtn');
    const fsEndBtn = document.getElementById('fsEndBtn');
    const fsNextBtn = document.getElementById('fsNextBtn');
    const fsMicBtn = document.getElementById('fsMicBtn');
    const fsShareBtn = document.getElementById('fsShareBtn');
    const fsSettingsBtn = document.getElementById('fsSettingsBtn');
    const fsChatBtn = document.getElementById('fsChatBtn');
    // Existing controls
    const startBtn = document.getElementById('startButton');
    const endBtn = document.getElementById('endButton');
    const muteBtn = document.getElementById('muteButton');
    const screenShareBtn = document.getElementById('screenShareButton');
    const settingsBtn = document.getElementById('settingsButton');
    const chatSection = document.querySelector('.chat-box');

  function inFullscreen() {
    return document.fullscreenElement === container;
  }

  function showHint() {
    if (!hint) return;
    hint.style.display = 'block';
    setTimeout(() => { if (hint) hint.style.display = 'none'; }, 3000);
  }

  async function enterFullscreen() {
    try {
      if (container.requestFullscreen) await container.requestFullscreen();
    } catch (e) {
      // if fullscreen fails, fall back to CSS-only mode
    }
    container.classList.add('fs-active');
    body.classList.add('fs-lock');
    fsBtn.innerHTML = '<i class="fa-solid fa-compress"></i>';
    showHint();
    if (fsToolbar) fsToolbar.style.display = 'flex';
    if (callTools) callTools.style.display = 'none';
    // Sync FS mic icon with current mute state
    try {
      const muted = window.__getMuteState ? window.__getMuteState() : false;
      const fsMicBtn = document.getElementById('fsMicBtn');
      if (fsMicBtn) {
        fsMicBtn.innerHTML = `<i class="fa-solid ${muted ? 'fa-microphone-slash' : 'fa-microphone'}"></i>`;
      }
    } catch {}
  }

  function exitFullscreen() {
    if (document.fullscreenElement) {
      document.exitFullscreen().catch(() => {});
    }
    container.classList.remove('fs-active');
    body.classList.remove('fs-lock');
    fsBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
    if (hint) hint.style.display = 'none';
    if (fsToolbar) fsToolbar.style.display = 'none';
    if (callTools) callTools.style.display = '';
    const fsChatPanel = document.getElementById('fsChatPanel');
    if (fsChatPanel) {
      fsChatPanel.dataset.open = '0';
      fsChatPanel.style.pointerEvents = 'none';
      fsChatPanel.style.opacity = '0';
      fsChatPanel.style.transform = 'translateX(100%)';
    }
  }

  fsBtn.addEventListener('click', function() {
    if (inFullscreen() || container.classList.contains('fs-active')) {
      exitFullscreen();
    } else {
      enterFullscreen();
    }
  });

  document.addEventListener('fullscreenchange', function() {
    if (inFullscreen()) {
      container.classList.add('fs-active');
      body.classList.add('fs-lock');
      fsBtn.innerHTML = '<i class="fa-solid fa-compress"></i>';
      if (fsToolbar) fsToolbar.style.display = 'flex';
      if (callTools) callTools.style.display = 'none';
      // Sync FS mic icon with current mute state
      try {
        const muted = window.__getMuteState ? window.__getMuteState() : false;
        const fsMicBtn = document.getElementById('fsMicBtn');
        if (fsMicBtn) {
          fsMicBtn.innerHTML = `<i class="fa-solid ${muted ? 'fa-microphone-slash' : 'fa-microphone'}"></i>`;
        }
      } catch {}
    } else {
      container.classList.remove('fs-active');
      body.classList.remove('fs-lock');
      fsBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
      if (hint) hint.style.display = 'none';
      if (fsToolbar) fsToolbar.style.display = 'none';
      if (callTools) callTools.style.display = '';
      const fsChatPanel = document.getElementById('fsChatPanel');
      if (fsChatPanel) {
        fsChatPanel.dataset.open = '0';
        fsChatPanel.style.pointerEvents = 'none';
        fsChatPanel.style.opacity = '0';
        fsChatPanel.style.transform = 'translateX(100%)';
      }
    }
  });

  // ESC exits fullscreen (native); also ensure our CSS state resets
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      container.classList.remove('fs-active');
      body.classList.remove('fs-lock');
      fsBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
      if (hint) hint.style.display = 'none';
      if (fsToolbar) fsToolbar.style.display = 'none';
      if (callTools) callTools.style.display = '';
    }
  });

  // Wire toolbar buttons to existing controls
  fsStartBtn && startBtn && fsStartBtn.addEventListener('click', () => startBtn.click());
  fsEndBtn && endBtn && fsEndBtn.addEventListener('click', () => endBtn.click());
  fsMicBtn && muteBtn && fsMicBtn.addEventListener('click', () => muteBtn.click());
  fsShareBtn && screenShareBtn && fsShareBtn.addEventListener('click', () => screenShareBtn.click());
  fsSettingsBtn && settingsBtn && fsSettingsBtn.addEventListener('click', () => settingsBtn.click());
  // FS Chat opens in-panel chat on the right
  if (fsChatBtn) {
    fsChatBtn.addEventListener('click', () => {
      const panel = document.getElementById('fsChatPanel');
      const nameEl = document.getElementById('fsChatName');
      const avatarEl = document.getElementById('fsChatAvatar');
      if (panel) {
        const isOpen = panel.dataset.open === '1';
        if (!isOpen) {
          // Opening: set header and animate in
          try {
            const nm = window.connectedUserName || '';
            if (nameEl) nameEl.textContent = nm || 'People';
            const em = window.connectedUserEmail || '';
            if (avatarEl) {
              if (window.__getAvatarByEmailOrUsername) {
                const src = window.__getAvatarByEmailOrUsername(em || nm);
                avatarEl.src = src;
              }
            }
          } catch {}
          panel.dataset.open = '1';
          panel.style.pointerEvents = 'auto';
          panel.style.opacity = '1';
          panel.style.transform = 'translateX(0)';
        } else {
          // Closing: animate out
          panel.dataset.open = '0';
          panel.style.pointerEvents = 'none';
          panel.style.opacity = '0';
          panel.style.transform = 'translateX(100%)';
        }
      }
    });
  }
  const fsChatCloseBtn = document.getElementById('fsChatClose');
  if (fsChatCloseBtn) {
    fsChatCloseBtn.addEventListener('click', () => {
      const panel = document.getElementById('fsChatPanel');
      if (panel) {
        panel.dataset.open = '0';
        panel.style.pointerEvents = 'none';
        panel.style.opacity = '0';
        panel.style.transform = 'translateX(100%)';
      }
    });
  }
  // FS Next triggers the same behavior as Start/Next button
  fsNextBtn && startBtn && fsNextBtn.addEventListener('click', () => {
    if (window.isCurrentlyMatched && window.isCurrentlyMatched()) {
      if (typeof window.goToNextMatch === 'function') {
        window.goToNextMatch();
      } else {
        startBtn.click();
      }
    } else {
      startBtn.click();
    }
    if (hint){
      hint.textContent='Next: finding another participant...';
      showHint();
      setTimeout(()=>{ hint.textContent='Press Esc to exit full screen'; }, 3000);
    }
  });
  });
})();
</script>
  <!-- ad -->
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="Peaple_header-logo.svg">

  <!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-messaging.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-functions.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-performance.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-remote-config.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-check.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-installations.js"></script> -->
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
<script>
// Initialize Firebase Auth object for browser
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyCnUEkbwEYruJ0YvbQkjFC9yfMDJsLqOlo",
    authDomain: "peaple-c3f4b.firebaseapp.com",
    projectId: "peaple-c3f4b",
    storageBucket: "peaple-c3f4b.firebasestorage.app",
    messagingSenderId: "814546020627",
    appId: "1:814546020627:web:c43c90fe6af9a0359e52e6",
    measurementId: "G-KHQMHRZ08F"
  });
}
window.auth = firebase.auth(); // Make auth globally available
</script>
<script>
  // API base for REST calls (adjust to your active backend)
  // For local development use localhost; when deploying via ngrok, set this to the ngrok URL.
  //window.API_BASE = 'http://localhost:3000';
  // Example for ngrok (uncomment and update):
  window.API_BASE = 'https://b0ceedc0c97c.ngrok-free.app'; //3000
</script>
 
  
  <style>
    .messages-container {
      width: 100%;
      height: 220px;
      overflow-y: auto;
      border: 1px solid #ccc;
      background: #f7f7fa;
      padding: 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .message {
      max-width: 70%;
      padding: 8px 14px;
      border-radius: 18px;
      font-size: 1em;
      word-break: break-word;
      margin-bottom: 2px;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .message.sent {
      background: #09ff00;
      color: #000;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      border-bottom-left-radius: 18px;
    }
    .message.received {
      background: #fff;
      color: #222;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 18px;
      border: 1px solid #e0e0e0;
    }
    /* Ensure colors are visible regardless of theme (higher specificity) */
    #messagesContainer .message.sent { background:#09ff00 !important; color:#000 !important; }
    #messagesContainer .message.received { background:#fff !important; color:#222 !important; border:1px solid #e0e0e0 !important; }
    #fsMessagesContainer .message.sent { background:#09ff00 !important; color:#000 !important; }
    #fsMessagesContainer .message.received { background:#fff !important; color:#222 !important; border:1px solid #e0e0e0 !important; }
    .input-container {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    #messageInput {
      flex: 1;
      border-radius: 18px;
      border: 1px solid #ccc;
      padding: 8px 14px;
      font-size: 1em;
      outline: none;
      background: #fff;
    }
    #sendButton {
      border-radius: 18px;
      background: #4caf50;
      color: #fff;
      border: none;
      padding: 8px 18px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendButton:hover {
      background: #388e3c;
    }
    .local-video-pip {
      position: absolute;
      bottom: 18px;
      right: 18px;
      width: 72px !important;
      height: 48px !important;
      z-index: 3;
      background: #e0e0e0;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      transition: width 0.25s cubic-bezier(.4,2,.6,1), height 0.25s cubic-bezier(.4,2,.6,1), box-shadow 0.18s;
      cursor: pointer;
      display: block;
      transform: scaleX(-1);
    }
    .local-video-pip:hover {
      width: 120px !important;
      height: 80px !important;
      box-shadow: 0 4px 16px rgba(0,0,0,0.22);
    }
    .local-video-placeholder {
      position: absolute;
      bottom: 18px;
      right: 18px;
      width: 72px;
      height: 48px;
      z-index: 4;
      background: #e0e0e0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      transition: width 0.25s, height 0.25s;
    }
    .local-video-pip:hover + .local-video-placeholder,
    .local-video-placeholder:hover {
      width: 120px;
      height: 80px;
    }
    .local-video-placeholder svg {
      width: 28px;
      height: 28px;
      color: #888;
      opacity: 0.7;
    }
    .local-video-pip.active + .local-video-placeholder {
      display: none !important;
    }
    #loginHeaderBtn {
      background: linear-gradient(90deg, #e3f2fd 0%, #fff 100%);
      border: 1px solid #90caf9;
      color: #1976d2;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 22px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(33,150,243,0.08);
      transition: background 0.18s, box-shadow 0.18s, color 0.18s;
    }
    #loginHeaderBtn:hover {
      background: linear-gradient(90deg, #bbdefb 0%, #e3f2fd 100%);
      color: #0d47a1;
      box-shadow: 0 4px 16px rgba(33,150,243,0.16);
    }
    .peas-low { color: #e53935 !important; }
    /* Make Connect Now header inline with no gap so warning hugs the title */
    .call-header { display:flex; align-items:center; gap:0; }
    .call-header .live-users { margin-left: 10px; }
    #peasWarning { white-space: nowrap; }
  </style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-container">
      <div class="header_logo">
        <a href="index.html"><img class="header_logo_img" src="Peaple_header-logo.svg" alt="Peaple Logo"></a>
      </div>
      <div class="profile">
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme" style="background:none;border:none;cursor:pointer;padding:6px 10px;border-radius:8px;display:flex;align-items:center;justify-content:center;">
          <i class="fa-solid fa-moon"></i>
        </button>
        <div id="profileDropdownWrapper" style="position:relative; display:none;">
          <img class="profileIcon" src="data:image/svg+xml;utf8,\
%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 80 80' fill='none'%3E\
%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E\
%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E\
%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E\
%3C/svg%3E" alt="Profile" id="profileIcon">
          <div class="profile-dropdown" id="profileDropdown" style="display:none; position:absolute; right:0; top:52px; background:#fff; box-shadow:0 4px 16px rgba(0,0,0,0.12); border-radius:10px; min-width:180px; z-index:100;">
            <a href="profile.html" class="dropdown-item"><i class="fa-solid fa-user fa-fw"></i> Profile</a>
            <a href="#" class="dropdown-item"><i class="fa-solid fa-crown fa-fw"></i> Subscription</a>
            <a href="#" class="dropdown-item"><i class="fa-solid fa-coins fa-fw"></i> Peas</a>
            <a href="#" class="dropdown-item"><i class="fa-solid fa-headset fa-fw"></i> Support</a>
            <a href="#" class="dropdown-item"><i class="fa-solid fa-file-lines fa-fw"></i> Terms & FAQ</a>
            <a href="#" id="dropdownLogout" class="dropdown-item"><i class="fa-solid fa-right-from-bracket fa-fw"></i> Log out</a>
          </div>
        </div>
        <button id="loginHeaderBtn" style="display:none; background:none; border:none; color:#444; font-size:1.08rem; font-weight:600; cursor:pointer; padding:8px 18px; border-radius:8px; transition:background 0.18s;">Log in</button>
        <!-- <i class="fa-duotone fa-solid fa-bars fa-lg menu"></i> -->
        <img src="hamburger-menu-svgrepo-com.svg" alt="menu" class="menu">
      </div>
    </div>
  </header>

  <!-- Banner -->
  <section class="banner">
    <div class="slides" id="slideContainer">
      <div class="slide">
        <img src="Untitled.jpeg" alt="slide1">
        <div class="slideText">
          <h2>Connect with top professionals</h2>
          <p>Grow your network via Peaple.<br>Know how our network works</p>
          <a href="#" class="banner-btn">Learn more</a>
        </div>
      </div>
      <div class="slide">
        <img src="Untitled1.jpeg" alt="slide2">
        <div class="slideText">
          <h2>Peaple is free</h2>
          <p>Try our new premium plans</p>
          <a href="#" class="banner-btn">Subscribe</a>
        </div>
      </div>
      <div class="slide">
        <img src="Untitled2.jpeg" alt="slide3">
        <div class="slideText">
          <h2>DOT is hiring</h2>
          <p>Get job offers at DOT. Your dreams are nearer</p>
          <a href="#" class="banner-btn">Apply</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Profile & Weekly Report Section -->
  <section class="profile-report-section">
    <div class="profile-card">
      <div class="profile-cover">
        <img class="profile-pic" src="data:image/svg+xml;utf8,\
%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 80 80' fill='none'%3E\
%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E\
%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E\
%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E\
%3C/svg%3E" alt="Profile">
      </div>
      <div class="profile-card-content">
  <h2 id="profileUserName">&nbsp;</h2>
        <div class="profile-title">Professional Title</div>
        <div class="professionalism-meter">
          <label>Professionalism Meter</label>
          <div class="professionalism-bar-bg">
            <div class="professionalism-bar"></div>
          </div>
        </div>
        <div class="peas-balance-row">
          <span>Peas Balance:</span>
          <span class="peas-count" id="profilePeasCount">&nbsp;</span>
        </div>
        <a href="#" class="transaction-link">View Transaction History</a>
        <a href="#" class="buy-peas-btn">Buy Peas</a>
      </div>
    </div>
    <div class="weekly-report-card">
      <h2>This Week's Report</h2>
      <div>Connections made: <strong>8</strong></div>
      <div>Peas earned: <strong>35</strong></div>
      <div>Calls duration: <strong>2h 15m</strong></div>
      <div>Professionalism change: <strong>+5%</strong></div>
    </div>
  </section>

  <!-- Call Section -->
  <section class="call-section">
    <div class="call-header">
      <div class="call-header-left">
        <h1>Connect Now</h1>
        <div id="peasWarning" style="display:none;color:#e53935;font-weight:600;font-size:0.95rem;">Insufficient peas, buy some to connect call!</div>
      </div>
      <div class="live-users"><i class="fa-solid fa-user"></i><span id="liveUsersCount"> 0</span> online</div>
    </div>
    <div class="call-main">
      <div class="search-people">
        <h3>Search People</h3>
        <input type="text" placeholder="Search users..." class="search-bar" id="searchPeopleInput">
  <div class="search-results" id="searchResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: #fff;">
          <!-- Users will be loaded here dynamically -->
        </div>
      </div>
      <div class="video-call">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h3 style="margin:0;">Video Call</h3>
          <button id="videoFullscreenBtn" class="video-fullscreen-btn" title="Fullscreen" aria-label="Fullscreen" style="background:none;border:none;cursor:pointer;padding:6px 10px;border-radius:8px;display:flex;align-items:center;justify-content:center;">
            <i class="fa-solid fa-expand"></i>
          </button>
        </div>
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
    <div id="connectedUserInfo" style="font-weight:600;color:#1976d2;"></div>
    <div id="callTimer" style="display:none;font-weight:600;color:#2e7d32;background:#e8f5e9;border:1px solid #c8e6c9;border-radius:8px;padding:4px 8px;min-width:62px;text-align:center;">00:00</div>
  </div>
        <div class="video-area">
          <div id="videoContainer" style="position:relative;width:100%;aspect-ratio:16/9;max-width:520px;margin:auto;">
            <video id="remoteVideo" autoplay style="z-index:1;width:100%;height:100%;background:#000;border-radius:16px;object-fit:cover;display:block;"></video>
            <div id="remoteOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;color:gray;font-size:1.2em;z-index:2;pointer-events:none;">Waiting for People</div>
            <video id="localVideo" autoplay muted class="local-video-pip"></video>
            <div id="localVideoPlaceholder" class="local-video-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 6a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2V8a2 2 0 00-2-2H4z" />
              </svg>
            </div>
            <div id="fsHint" class="fs-hint" style="display:none; position:absolute; top:12px; left:50%; transform:translateX(-50%); background: rgba(0,0,0,0.7); color:#fff; padding:6px 10px; border-radius:8px; font-size:0.95rem; z-index:5;">Press Esc to exit full screen</div>
            <!-- FS toolbar (simplified) -->
            <div id="fsToolbar" class="fs-toolbar" style="display:none;">
              <button class="fs-btn" id="fsStartBtn" title="Start"><i class="fa-solid fa-phone"></i></button>
              <button class="fs-btn fs-leave" id="fsEndBtn" title="End"><i class="fa-solid fa-phone-slash"></i></button>
              <button class="fs-btn" id="fsNextBtn" title="Next"><i class="fa-solid fa-forward"></i></button>
              <span class="fs-sep"></span>
              <button class="fs-btn" id="fsMicBtn" title="Mute / Unmute"><i class="fa-solid fa-microphone"></i></button>
              <button class="fs-btn" id="fsShareBtn" title="Share Screen"><i class="fa-solid fa-display"></i></button>
              <button class="fs-btn" id="fsSettingsBtn" title="Settings"><i class="fa-solid fa-gear"></i></button>
              <button class="fs-btn" id="fsChatBtn" title="Chat"><i class="fa-solid fa-message"></i></button>
            </div>

            <!-- Fullscreen Chat Panel (WhatsApp-like) -->
            <div id="fsChatPanel" aria-label="Chat" style="position:absolute; top:0; right:0; height:100%; width:clamp(280px, 34vw, 420px); background:#ffffff; backdrop-filter:saturate(180%) blur(8px); box-shadow:-6px 0 18px rgba(0,0,0,0.25); z-index:10; border-top-right-radius:16px; border-bottom-right-radius:16px; overflow:hidden; box-sizing:border-box; border-left:1px solid rgba(0,0,0,0.06); transform: translateX(100%); opacity: 0; pointer-events: none; transition: transform .28s cubic-bezier(.4,0,.2,1), opacity .2s;">
              <div id="fsChatHeader" style="position:absolute; top:0; left:0; right:0; height:56px; display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid #eee; background:#f7f9fc; box-sizing:border-box;">
                <img id="fsChatAvatar" src="data:image/svg+xml;utf8,\
%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 80 80' fill='none'%3E\
%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E\
%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E\
%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E\
%3C/svg%3E" alt="Avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
                <div style="display:flex; flex-direction:column;">
                  <div id="fsChatName" style="font-weight:700; font-size:0.98rem;">&nbsp;</div>
                  <div id="fsChatSubtitle" style="font-size:0.8rem; color:#7a7a7a;">Online</div>
                </div>
                <button id="fsChatClose" title="Close" aria-label="Close chat" style="margin-left:auto;background:none;border:none;font-size:1.2rem;color:#777;cursor:pointer;">&times;</button>
              </div>
              <div id="fsMessagesContainer" style="position:absolute; top:56px; bottom:64px; left:0; right:0; overflow-y:auto; padding:12px 14px; background:#f9fbff; display:flex; flex-direction:column; gap:8px; box-sizing:border-box;"></div>
              <div id="fsChatInputBar" style="position:absolute; bottom:0; left:0; right:0; height:64px; border-top:1px solid #eee; display:flex; align-items:center; gap:8px; padding:10px 12px calc(12px + env(safe-area-inset-right, 0px)) calc(12px + env(safe-area-inset-left, 0px)); background:#ffffff; box-sizing:border-box;">
                <div style="position:relative; flex:1;">
                  <input id="fsMessageInput" type="text" placeholder="Type a message" style="width:100%; border:1px solid #ddd; background:#fff; border-radius:22px; padding:12px 46px 12px 14px; outline:none; font-size:1rem; box-sizing:border-box;">
                  <button id="fsSendButton" title="Send" aria-label="Send" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:#4caf50; color:#fff; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(76,175,80,0.35);">
                    <i class="fa-solid fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="call-tools">
          <div style="display:flex;justify-content:center;align-items:center;gap:18px;width:100%;">
            <button id="muteButton" title="Mute" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;">
              <i id="muteIcon" class="fa-solid fa-microphone" style="font-size:1.1em;color:#333;"></i>
            </button>
            <button id="startButton" style="display:flex;align-items:center;">Start Call</button>
            <button id="endButton" title="End Call" style="background:none;border:none;cursor:pointer;display:none;padding:0;align-items:center;">
              <i class="fa-solid fa-phone-slash" style="font-size:1.1em;color:#e53935;"></i>
            </button>
            <button id="screenShareButton" title="Share Screen" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;">
              <i class="fa-solid fa-display" style="font-size:1.1em;color:#333;"></i>
            </button>
            <button id="settingsButton" title="Settings" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;">
              <i class="fa-solid fa-gear" style="font-size:1.1em;color:#333;"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="chat-box">
        <h3>Chat</h3>
        <div id="messagesContainer" class="messages-container" style="width:100%;height:220px;overflow-y:auto;border:1px solid #ccc;background:#fff;padding:8px;box-sizing:border-box;"></div>
        <div class="input-container" style="display:flex;gap:8px;">
          <input type="text" id="messageInput" placeholder="Type a message..." style="flex:1;">
          <button id="sendButton">Send</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent Connections -->
  <section class="recent-connections">
    <h2>Recent Connections</h2>
    <div class="connection-list">
      <div class="connection-item">
        <img src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 80 80' fill='none'%3E%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E%3C/svg%3E" alt="User">
        <div class="conn-info">
          <span>User Name</span>
          <span class="user-prof">Professional</span>
        </div>
        <div class="conn-meta">
          <span>2 days ago</span>
          <button class="reconnect-btn">Reconnect</button>
        </div>
      </div>
      <div class="connection-item">
        <img src="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 80 80' fill='none'%3E%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E%3C/svg%3E" alt="User">
        <div class="conn-info">
          <span>User Name</span>
          <span class="user-prof">Professional</span>
        </div>
        <div class="conn-meta">
          <span>5 hr ago</span>
          <button class="reconnect-btn">Reconnect</button>
        </div>
      </div>
    </div>
    <a href="#" class="view-all-connections">View all connections</a>
  </section>

  <!-- All Connections Slide-in Panel -->
  <div id="allConnectionsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000; align-items:stretch; justify-content:flex-end;">
    <div id="allConnectionsPanel" role="dialog" aria-label="All Connections" style="height:100%; width:min(720px, 92vw); background:#ffffff; box-shadow:-8px 0 24px rgba(0,0,0,0.3); border-left:1px solid #e5e7eb; display:flex; flex-direction:column; transform: translateX(100%); transition: transform .28s cubic-bezier(.4,0,.2,1);">
      <div style="display:flex; align-items:center; gap:12px; padding:12px 14px; border-bottom:1px solid #eee; background:#f7f9fc;">
        <h3 style="margin:0; font-size:1.05rem;">All Connections</h3>
        <button id="allConnCloseBtn" title="Close" aria-label="Close" style="margin-left:auto; background:none; border:none; font-size:1.4rem; color:#666; cursor:pointer">&times;</button>
      </div>
      <div id="allConnectionsList" style="flex:1; overflow-y:auto; padding:12px 14px;">
        <!-- Filled by client.js -->
      </div>
    </div>
  </div>

  <style>
    /* Dark mode for All Connections overlay/panel */
    html[data-theme="dark"] #allConnectionsOverlay {
      background: rgba(0,0,0,0.6) !important;
      backdrop-filter: blur(2px);
    }
    html[data-theme="dark"] #allConnectionsPanel {
      background: #0f172a !important; /* slate-900 */
      color: #e2e8f0 !important;      /* slate-200 */
      border-left-color: rgba(255,255,255,0.08) !important;
    }
    html[data-theme="dark"] #allConnectionsPanel > div:first-child {
      background: #0b1220 !important;
      border-bottom-color: rgba(255,255,255,0.08) !important;
    }
    /* List rows and subtle separators */
    #allConnectionsList::-webkit-scrollbar { width: 10px; }
    #allConnectionsList::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.18); border-radius: 10px; }
    html[data-theme="dark"] #allConnectionsList::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); }
  </style>

  <!-- Feedback Section -->
  <section class="feedback-section">
    <h2>Feedback</h2>
    <div class="feedback-list">
      <div class="feedback-item">
        <span>User Name</span>
        <span>⭐⭐⭐⭐⭐</span>
        <span>Great call experience!</span>
      </div>
      <div class="feedback-item">
        <span>User Name</span>
        <span>⭐⭐⭐⭐</span>
        <span>Good, but can improve.</span>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <script>
      // Banner slider functionality
      const slides = document.getElementById("slideContainer");
      let currentSlide = 0;
      function updateSlidePosition() {
        slides.style.transform = `translateX(-${currentSlide * 100}%)`;
      }
      setInterval(() => {
        currentSlide = (currentSlide + 1) % slides.children.length;
        updateSlidePosition();
      }, 3000);

      // Profile dropdown functionality
      const profileIcon = document.getElementById('profileIcon');
      const profileDropdown = document.getElementById('profileDropdown');
      profileIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = profileDropdown.style.display === 'block';
        profileDropdown.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) {
          profileIcon.classList.add('profile-focused');
        } else {
          profileIcon.classList.remove('profile-focused');
        }
      });
      document.addEventListener('click', function(e) {
        if (profileDropdown.style.display === 'block') {
          profileDropdown.style.display = 'none';
          profileIcon.classList.remove('profile-focused');
        }
      });
      // Logout confirmation modal logic
      const logoutModalHtml = `
        <div id="logoutConfirmModal" class="modal-overlay" style="display:none;">
          <div class="modal-window" style="min-width:320px;max-width:90vw;text-align:center;">
            <h2 class="modal-title" style="font-size:1.3rem;color:#e53935;">You are trying to log out!</h2>
            <div style="margin:18px 0 28px 0;font-size:1.08rem;color:#444;">Are you sure?</div>
            <div style="display:flex;justify-content:space-between;gap:18px;">
              <button id="logoutCancelBtn" style="flex:1;background:#eee;color:#333;border:none;border-radius:8px;padding:10px 0;font-size:1.08rem;font-weight:600;cursor:pointer;transition:background 0.18s;">Cancel</button>
              <button id="logoutConfirmBtn" style="flex:1;background:#e53935;color:#fff;border:none;border-radius:8px;padding:10px 0;font-size:1.08rem;font-weight:600;cursor:pointer;transition:background 0.18s;margin-left:12px;">Log out</button>
            </div>
            <button class="modal-close" id="logoutModalCloseBtn" style="position:absolute;top:10px;right:16px;background:none;border:none;font-size:1.6rem;color:#aaa;cursor:pointer;transition:color 0.18s;">&times;</button>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', logoutModalHtml);

      const logoutModal = document.getElementById('logoutConfirmModal');
      const openLogoutModal = () => { logoutModal.style.display = 'flex'; };
      const closeLogoutModal = () => { logoutModal.style.display = 'none'; };
      document.getElementById('logoutModalCloseBtn').onclick = closeLogoutModal;
      document.getElementById('logoutCancelBtn').onclick = closeLogoutModal;
      document.getElementById('logoutConfirmBtn').onclick = function() {
        auth.signOut().then(() => window.location.href = 'login.html');
      };
      const dropdownLogout = document.getElementById('dropdownLogout');
      if (dropdownLogout) {
        dropdownLogout.addEventListener('click', function(e) {
          e.preventDefault();
          openLogoutModal();
        });
      }
    </script>
    <div class="footer-main">
      <div class="footer-features">
        <h4>Product Features</h4>
        <a href="#">Pricing</a>
        <a href="#">FAQ</a>
      </div>
      <div class="footer-company">
        <h4>Company</h4>
        <a href="#">About</a>
        <a href="#">Careers</a>
        <a href="#">Contact</a>
      </div>
      <div class="footer-legal">
        <h4>Legal</h4>
        <a href="#">Privacy</a>
        <a href="#">Terms</a>
        <a href="#">Cookie Policy</a>
      </div>
      <div class="footer-social">
        <h4>Follow Us</h4>
        <a href=" https://x.com/SoulTechYT2?t=dtXMcyBBl-tE33wNeMJSRg&s=08 "><i class="fa-brands fa-x-twitter fa-lg"></i></a>
        <a href="https://www.linkedin.com/in/vignesh-p-2a05b0254?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app"><i class="fa-brands fa-linkedin-in fa-lg"></i></a>
        <a href="https://www.instagram.com/vixin.debian?igsh=cDZuNDhoNGIyc21t"><i class="fa-brands fa-instagram fa-lg"></i></a>
        <a href="https://www.facebook.com/share/1JH7zF32ho/?mibextid=qi2Omg"><i class="fa-brands fa-facebook-f fa-lg"></i></a>
      </div>
    </div>
    <div class="footer-copyright">
      &copy; 2025 Peaple. All rights reserved.
    </div>
  </footer>
</body>

<script>

// Modal logic for login/register
const modalHtml = `
  <div id="loginRegisterModal" class="modal-overlay" style="display:none;">
    <div class="modal-window">
      <h2 class="modal-title">Log in to make call</h2>
      <div class="modal-section">
        <div class="modal-desc">If you already have an account, then</div>
        <button class="modal-btn" id="modalLoginBtn">Log In</button>
      </div>
      <div class="modal-or"><span>or</span></div>
      <div class="modal-section">
        <div class="modal-desc">New here? Join as Peaple!</div>
        <button class="modal-btn" id="modalRegisterBtn">Register</button>
      </div>
      <button class="modal-close" id="modalCloseBtn">&times;</button>
    </div>
  </div>
`;
document.body.insertAdjacentHTML('beforeend', modalHtml);

// Modal CSS
const modalStyle = document.createElement('style');
modalStyle.innerHTML = `
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 9999;
  }
  .modal-window {
    background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    padding: 36px 32px 24px 32px; min-width: 320px; max-width: 90vw; position: relative; text-align: center;
    animation: modalPop 0.2s cubic-bezier(.4,2,.6,1) 1;
  }
  @keyframes modalPop { from { transform: scale(0.92); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 18px; color: #2db2ff; }
  .modal-section { margin-bottom: 18px; }
  .modal-desc { font-size: 1.08rem; color: #444; margin-bottom: 10px; }
  .modal-btn {
    width: 100%; padding: 10px 0; border-radius: 8px; border: none; font-size: 1.08rem; font-weight: 600;
    background: linear-gradient(90deg, #2db2ff 60%, #09ff00 100%); color: #fff; margin-bottom: 4px; cursor: pointer;
    transition: background 0.18s, color 0.18s, transform 0.18s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .modal-btn:hover { background: #249643; color: #fff; transform: scale(1.04); }
  .modal-or { margin: 10px 0 18px 0; position: relative; text-align: center; }
  .modal-or span { background: #fff; padding: 0 12px; color: #aaa; font-size: 1rem; position: relative; z-index: 1; }
  .modal-or:before { content: ""; display: block; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #eee; z-index: 0; }
  .modal-close {
    position: absolute; top: 10px; right: 16px; background: none; border: none; font-size: 1.6rem; color: #aaa; cursor: pointer;
    transition: color 0.18s;
  }
  .modal-close:hover { color: #e53935; }
`;
document.head.appendChild(modalStyle);

// Modal JS logic
const modal = document.getElementById('loginRegisterModal');
const openModal = () => { modal.style.display = 'flex'; };
const closeModal = () => { modal.style.display = 'none'; };
document.getElementById('modalCloseBtn').onclick = closeModal;
document.getElementById('modalLoginBtn').onclick = () => { window.location.href = 'login.html#login'; };
document.getElementById('modalRegisterBtn').onclick = () => { window.location.href = 'login.html#register'; };
window.addEventListener('keydown', (e) => { if (modal.style.display === 'flex' && e.key === 'Escape') closeModal(); });

// Start/Next button logic (single handler)
const startBtn = document.getElementById('startButton');
if (startBtn) {
  const onStartOrNext = function(e) {
    e.preventDefault();
    const showPeasWarning = () => {
      const w = document.getElementById('peasWarning');
      if (w) { w.style.display = ''; w.textContent = 'Insuffecient peas, buy some to connect call!'; }
    };
    const hidePeasWarning = () => {
      const w = document.getElementById('peasWarning');
      if (w) { w.style.display = 'none'; }
    };
    const ensurePeas = async (user) => {
      if (!user) return 0;
      if (typeof window.__myPeas === 'number') return window.__myPeas;
      try {
        const res = await fetch((window.API_BASE || 'https://b0ceedc0c97c.ngrok-free.app') + '/api/peas/' + encodeURIComponent(user.email)); //3000
        if (res.ok) { const j = await res.json(); window.__myPeas = Number(j.peas || 0); return window.__myPeas; }
      } catch {}
      return 0;
    };
    const proceed = async (user) => {
      if (!user) { openModal(); return; }
      const peas = await ensurePeas(user);
      if (Number(peas) <= 5) { showPeasWarning(); return; } else { hidePeasWarning(); }
      if (window.isCurrentlyMatched && window.isCurrentlyMatched()) {
        if (typeof window.goToNextMatch === 'function') {
          window.goToNextMatch();
        }
      } else {
        if (typeof startCallIfAuthenticated === 'function') {
          startCallIfAuthenticated();
        }
      }
    };
    // Use current state if already available; otherwise wait for initial callback
    const curr = auth.currentUser;
    if (curr !== undefined) {
      proceed(curr);
    } else {
      auth.onAuthStateChanged(proceed);
    }
  };
  // Remove any previous listeners by resetting onclick then adding one
  startBtn.onclick = null;
  startBtn.addEventListener('click', onStartOrNext);
}

// Profile header logic: show Log in if not logged in, show profile if logged in
window.addEventListener('DOMContentLoaded', function() {
  const profileDropdownWrapper = document.getElementById('profileDropdownWrapper');
  const loginHeaderBtn = document.getElementById('loginHeaderBtn');
  auth.onAuthStateChanged(function(user) {
    if (user) {
      // Show profile icon/dropdown
      profileDropdownWrapper.style.display = '';
      loginHeaderBtn.style.display = 'none';
      // Update top nav profile icon image
      try {
        const icon = document.getElementById('profileIcon');
        const default40 = "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 80 80' fill='none'%3E%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E%3C/svg%3E";
        if (icon) icon.src = (user.photoURL && user.photoURL.trim()) ? user.photoURL : default40;
      } catch {}
    } else {
      // Show Log in button
      profileDropdownWrapper.style.display = 'none';
      loginHeaderBtn.style.display = '';
      try {
        const icon = document.getElementById('profileIcon');
        const default40 = "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 80 80' fill='none'%3E%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E%3C/svg%3E";
        if (icon) icon.src = default40;
      } catch {}
    }
  });
  if (loginHeaderBtn) {
    loginHeaderBtn.onclick = function() {
      window.location.href = 'login.html#login';
    };
  }
  // Display user name and profile picture in profile card
  const profileNameEl = document.getElementById('profileUserName');
  const profileCardContent = document.querySelector('.profile-card-content');
  const profilePicEl = document.querySelector('.profile-pic');
  async function setProfileCard(user) {
    const peasCountEl = document.getElementById('profilePeasCount');
    const buyPeasBtn = document.querySelector('.buy-peas-btn');
    if (!user) {
  if (profileNameEl) profileNameEl.textContent = ' ';
      if (profilePicEl) profilePicEl.src = 'https://i.pravatar.cc/100';
  if (peasCountEl) peasCountEl.textContent = ' ';
      if (buyPeasBtn) buyPeasBtn.onclick = null;
      const titleEl = document.querySelector('.profile-title');
      if (titleEl) titleEl.textContent = 'User';
      return;
    }
    // Fetch user from backend to get avatarUrl and peas if available
    let avatar = '';
    let peas = 0;
    try {
      const res = await fetch('https://b0ceedc0c97c.ngrok-free.app/api/users'); //3000
      const users = await res.json();
      const found = users.find(u => u.email === user.email);
      avatar = found && found.avatarUrl ? found.avatarUrl : '';
      peas = found && typeof found.peas === 'number' ? found.peas : 0;
      // Set profile card title to user's bio from DB
      const titleEl = document.querySelector('.profile-title');
      if (titleEl) {
        titleEl.textContent = (found && found.bio) ? found.bio : 'User';
      }
    } catch {}
    if (!avatar && user.photoURL) avatar = user.photoURL;
    if (!avatar) avatar = "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 80 80' fill='none'%3E%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E%3C/svg%3E";
    if (profilePicEl) profilePicEl.src = avatar;
    if (profileNameEl) profileNameEl.textContent = user.displayName || user.email || 'User';
    if (peasCountEl) {
      peasCountEl.textContent = peas;
      peasCountEl.classList.toggle('peas-low', Number(peas) <= 5);
    }
    window.__myPeas = peas;
    // Buy Peas button logic (demo: add 10 peas)
    if (buyPeasBtn) {
      buyPeasBtn.onclick = async function(e) {
        e.preventDefault();
        try {
          const res = await fetch('https://b0ceedc0c97c.ngrok-free.app/api/peas/update',//3000
           {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: user.email, amount: 10 })
          });
          const data = await res.json();
          if (typeof data.peas === 'number') {
            if (peasCountEl) {
              peasCountEl.textContent = data.peas;
              peasCountEl.classList.toggle('peas-low', Number(data.peas) <= 5);
            }
            window.__myPeas = data.peas;
          }
        } catch {}
      };
    }
    // remove any legacy profile edit button if present
    if (profileCardContent) {
      const oldEditBtn = profileCardContent.querySelector('.profile-edit-btn');
      if (oldEditBtn) oldEditBtn.remove();
    }
  }
  auth.onAuthStateChanged(async function(user) {
    if (user) {
      // Always register/sync user in backend DB
      try {
        await fetch('https://b0ceedc0c97c.ngrok-free.app/api/register',//3000
         {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: user.displayName || '',
            email: user.email,
            password: '', // Not needed for Google, but required by schema
            avatarUrl: user.photoURL || ''
          })
        });
      } catch (e) { /* ignore errors for now */ }
    }
    setProfileCard(user);
  });
});
</script>



<script>
// Show connected user's name in the video call section
function showConnectedUserName(name) {
  const infoDiv = document.getElementById('connectedUserInfo');
  if (infoDiv) {
    if (name) {
      infoDiv.textContent = `Connected to ${name}`;
      infoDiv.style.display = '';
    } else {
      infoDiv.textContent = '';
      infoDiv.style.display = 'none';
    }
  }
}
window.showConnectedUserName = showConnectedUserName;

// Example: listen for a custom event or call this function when a connection is made
// Replace this with your actual connection logic
// Example usage:
// showConnectedUserName('Vignesh');

// If you use WebSocket or other signaling, call showConnectedUserName with the connected user's name when matched
</script>
<script src="client.js?v=5"></script>

<script>
// Theme: apply saved preference and toggle
(function() {
  const root = document.documentElement;
  const saved = localStorage.getItem('theme') || 'light';
  root.setAttribute('data-theme', saved);
  const btn = document.getElementById('themeToggle');
  function syncIcon() {
    if (!btn) return;
    const isDark = root.getAttribute('data-theme') === 'dark';
    btn.innerHTML = `<i class="fa-solid ${isDark ? 'fa-sun' : 'fa-moon'}"></i>`;
  }
  syncIcon();
  if (btn) {
    btn.addEventListener('click', function() {
      const current = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', current);
      localStorage.setItem('theme', current);
      syncIcon();
    });
  }
})();

// Fetch users from backend and display in Search People section

let allUsers = [];
async function loadUsersToSearch() {
  try {
    const res = await fetch('https://b0ceedc0c97c.ngrok-free.app/api/users'); //3000
    allUsers = await res.json();
    window.allUsers = allUsers; // Expose globally for client.js
    renderUserList(allUsers);
  } catch (e) {
    console.error('Failed to load users', e);
  }
}

function renderUserList(users) {
  const searchResults = document.getElementById('searchResults');
  searchResults.innerHTML = '';
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = 'user-result';
    const avatar = (user.avatarUrl && user.avatarUrl.startsWith('http'))
      ? user.avatarUrl
      : (user.photoURL && user.photoURL.startsWith('http'))
        ? user.photoURL
        : "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 80 80' fill='none'%3E%3Crect width='80' height='80' rx='40' fill='%23e5e7eb'/%3E%3Ccircle cx='40' cy='32' r='14' fill='%239ca3af'/%3E%3Cpath d='M16 66c6-12 18-18 24-18s18 6 24 18' fill='%239ca3af'/%3E%3C/svg%3E";
    const emailLower = (user.email ? String(user.email).toLowerCase() : '');
    const isOnline = !!(window.__onlineEmails && window.__onlineEmails.has(emailLower));
    div.innerHTML = `
      <div class="avatar-wrap" style="position:relative;display:inline-block;width:40px;height:40px;">
        <img src="${avatar}" alt="User" style="border-radius:50%;width:40px;height:40px;object-fit:cover;">
        ${isOnline ? '<span class="online-dot" style="position:absolute;right:-1px;bottom:-1px;width:10px;height:10px;border-radius:50%;background:#22c55e;border:2px solid #fff;"></span>' : ''}
      </div>
      <span>${user.username || user.email}</span>
      <span class="user-prof" title="${(user.profession||'').replace(/"/g,'&quot;')}">${user.profession || 'User'}</span>
    `;
    searchResults.appendChild(div);
  });
}

window.addEventListener('DOMContentLoaded', () => {
  loadUsersToSearch();
  const searchInput = document.getElementById('searchPeopleInput');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const val = this.value.trim().toLowerCase();
      if (!val) {
        renderUserList(allUsers);
      } else {
        renderUserList(allUsers.filter(u =>
          (u.username && u.username.toLowerCase().includes(val)) ||
          (u.email && u.email.toLowerCase().includes(val)) ||
          (u.profession && u.profession.toLowerCase().includes(val))
        ));
      }
    });
  }
  // Presence: heartbeat + live count
  (function initPresence(){
    const BASE = (window.API_BASE || 'https://b0ceedc0c97c.ngrok-free.app');
    const countEl = document.getElementById('liveUsersCount');
    let currentId = '';
    let lastBeatOk = 0;
    function computePresenceId() {
      // prefer stable auth identity, else persisted anon id
      try { if (auth && auth.currentUser && auth.currentUser.email) return 'user:' + auth.currentUser.email; } catch {}
      let id = localStorage.getItem('presenceId');
      if (!id) {
        id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('anon-' + Date.now() + '-' + Math.random().toString(36).slice(2));
        localStorage.setItem('presenceId', id);
      }
      return 'anon:' + id;
    }
    currentId = computePresenceId();
    async function beat(aliases) {
      try {
        await fetch(BASE + '/api/presence/beat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: currentId, aliases: Array.isArray(aliases) ? aliases : [] })
        });
        lastBeatOk = Date.now();
      } catch {}
    }
    async function refreshCount() {
      try {
        const res = await fetch(BASE + '/api/presence/count');
        if (!res.ok) return;
        const { count } = await res.json();
        const n = (typeof count === 'number' ? count : 0);
        if (countEl) countEl.textContent = ' ' + n;
      } catch {}
    }
    // initial
    beat();
    setTimeout(refreshCount, 400); // small delay to allow the first beat to register
    // periodic
    setInterval(beat, 15000);         // every 15s
    setInterval(refreshCount, 12000); // every 12s
    // on auth change, send immediate beat with new identity
    try {
      auth.onAuthStateChanged(() => {
        const oldId = currentId;
        currentId = computePresenceId();
        // send beat with alias = oldId to dedupe server-side
        beat(oldId ? [oldId] : []);
        refreshCount();
      });
    } catch {}
    // on tab visibility regain, send beat and refresh
    document.addEventListener('visibilitychange', () => { if (!document.hidden) { beat(); refreshCount(); } });
    // on unload, send leave beacon to drop immediately
    window.addEventListener('beforeunload', () => {
      try {
        const payload = JSON.stringify({ id: currentId || computePresenceId() });
        navigator.sendBeacon(BASE + '/api/presence/leave', new Blob([payload], { type: 'application/json' }));
      } catch {}
    });
    // fetch online authenticated emails periodically and update UI badges
    async function refreshOnlineList() {
      try {
        const res = await fetch(BASE + '/api/presence/online');
        if (!res.ok) return;
        const data = await res.json();
        const emails = Array.isArray(data.users) ? data.users : [];
        window.__onlineEmails = new Set(emails.map(e => String(e).toLowerCase()));
        // rerender search list to show dots
        renderUserList(allUsers);
        // notify client.js to refresh recents/all connections dots
        if (window.__refreshRecentsOnline) window.__refreshRecentsOnline();
      } catch {}
    }
    // initial and periodic
    refreshOnlineList();
    setInterval(refreshOnlineList, 12000);
  })();
});
</script>
</html>
