<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login to Peaple</title>

    <!-- ads -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7220479975152766"
      crossorigin="anonymous"
    ></script>

    <!-- icons for theme toggle -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <!-- tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>

    <script>
      // Init Firebase - keep your own config
      if (!firebase.apps.length) {
        firebase.initializeApp({
          apiKey: "AIzaSyCnUEkbwEYruJ0YvbQkjFC9yfMDJsLqOlo",
          authDomain: "peaple-c3f4b.firebaseapp.com",
          projectId: "peaple-c3f4b",
          storageBucket: "peaple-c3f4b.firebasestorage.app",
          messagingSenderId: "814546020627",
          appId: "1:814546020627:web:c43c90fe6af9a0359e52e6",
          measurementId: "G-KHQMHRZ08F",
        });
      }
      // compat auth object available as auth
      window.auth = firebase.auth();
    </script>
    <style>
      /* Loading Animation */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
      }

      [data-theme="dark"] #loading-overlay {
        background: #0f172a;
      }

      .loader {
        width: 48px;
        height: 48px;
        border: 5px solid #4a6bff;
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }

      .loading-text {
        margin-top: 16px;
        color: #4a6bff;
        font-size: 1.1rem;
        font-weight: 500;
      }

      [data-theme="dark"] .loading-text {
        color: #a5b4fc;
      }

      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .fade-out {
        opacity: 0;
        visibility: hidden;
      }
      /* Ensure login page respects global theme */
      html[data-theme="dark"] body {
        background: linear-gradient(180deg, #0b1220, #0a0f1f) !important;
      }
      /* floating theme toggle */
      #loginThemeToggle {
        position: fixed; top: 18px; right: 18px;
        background: var(--surface); color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 10px; padding: 8px 10px; cursor: pointer;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000;
      }
      #loginThemeToggle:hover { box-shadow: 0 10px 26px rgba(0,0,0,0.25); }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 min-h-screen flex items-center justify-center"
  >
    <!-- Loading Overlay -->
    <div id="loading-overlay">
      <span class="loader"></span>
      <span class="loading-text">Loading Peaple...</span>
    </div>
    <!-- Theme toggle (floating) -->
    <button id="loginThemeToggle" aria-label="Toggle theme" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
    <!-- header -->
    <div class="header_logo" style="position: absolute; top: 20px; left: 20px">
      <a href="index.html"
        ><img
          class="header_logo_img"
          src="Peaple_header-logo.svg"
          alt="Peaple Logo"
          style="width: 100px; height: 100px"
      /></a>
    </div>

    <div
      id="authCard"
      class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 transition-all duration-500 ease-in-out"
      style="opacity: 1; transform: scale(1)"
    >
      <div class="mb-6 text-center">
        <h1 class="text-3xl font-bold text-indigo-700">Join here as Peaple</h1>
        <p class="text-gray-600">Peaple - for - People.</p>
      </div>

      <!-- Toggle Buttons -->
      <div class="flex justify-center mb-6 space-x-4 relative">
        <button
          id="loginBtn"
          class="py-2 px-4 text-white bg-indigo-600 rounded-full relative z-10 transition-all duration-300"
        >
          Login
        </button>
        <button
          id="registerBtn"
          class="py-2 px-4 text-indigo-600 border border-indigo-600 rounded-full relative z-10 transition-all duration-300"
        >
          Register
        </button>
        <span
          id="toggleUnderline"
          class="absolute bottom-0 left-0 h-1 bg-indigo-400 rounded-full transition-all duration-300"
          style="width: 0px; height: 0px; z-index: 1"
        ></span>
      </div>

      <!-- Passwordless Email Link Sign-in -->
      <div class="mb-4 p-3 rounded-lg bg-blue-50 border border-blue-200">
        <label
          for="emailLinkInput"
          class="block text-blue-700 text-sm font-semibold mb-1"
          >Sign in with Email Link:</label
        >
        <div class="flex gap-2">
          <input
            type="email"
            id="emailLinkInput"
            name="emailLinkInput"
            placeholder="Enter your email for link sign-in"
            class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
          <button
            type="button"
            id="sendEmailLinkBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Send Link
          </button>
        </div>
        <div class="text-xs text-blue-700 mt-1">
          A sign-in link will be sent to your email. Click it to sign in.
        </div>
        <div
          id="emailLinkStatus"
          class="text-green-600 text-sm mt-2 mb-2"
          style="display:none;"
        ></div>
      </div>

      <!-- Login Form -->
      <form
        id="loginForm"
        class="space-y-4 transition-all duration-500 ease-in-out"
      >
        <input
          type="email"
          id="loginEmail"
          name="loginEmail"
          placeholder="Email"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
          required
        />
        <input
          type="password"
          id="loginPassword"
          name="loginPassword"
          placeholder="Password"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
          required
        />
        <div
          id="loginError"
          class="text-red-600 text-sm mt-1 mb-1"
          style="display: none"
        ></div>
        <button
          type="submit"
          class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
        >
          Login
        </button>

        <div class="flex items-center justify-between mt-4">
          <hr class="w-1/4 border-gray-300" />
          <span class="text-gray-500 text-sm">or continue with</span>
          <hr class="w-1/4 border-gray-300" />
        </div>

        <div class="flex space-x-4 mt-4 justify-center">
          <button
            id="googleLoginBtn"
            class="bg-white border px-4 py-2 rounded-lg shadow hover:bg-gray-100 flex items-center space-x-2"
          >
            <img
              src="https://www.svgrepo.com/show/475656/google-color.svg"
              class="w-5 h-5"
            />
            <span class="text-sm">Google</span>
          </button>
          <button
            id="linkedinLoginBtn"
            class="bg-[#0A66C2] text-white px-4 py-2 rounded-lg hover:bg-[#004182] transition-colors flex items-center space-x-2"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/>
            </svg>
            <span class="text-sm">LinkedIn</span>
          </button>
        </div>
      </form>

      <!-- Register Form -->
      <form
        id="registerForm"
        class="space-y-4 hidden transition-all duration-500 ease-in-out"
      >
        <div class="flex space-x-2">
          <input
            type="text"
            id="registerFirstName"
            name="registerFirstName"
            placeholder="First Name"
            class="w-1/2 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
            required
          />
          <input
            type="text"
            id="registerLastName"
            name="registerLastName"
            placeholder="Last Name"
            class="w-1/2 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
            required
          />
        </div>
        <input
          type="email"
          id="registerEmail"
          name="registerEmail"
          placeholder="Email"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
          required
        />
        <input
          type="password"
          id="registerPassword"
          name="registerPassword"
          placeholder="Create Password"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
          required
        />
        <input
          type="password"
          id="registerConfirmPassword"
          name="registerConfirmPassword"
          placeholder="Confirm Password"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400"
          required
        />
        <button
          type="submit"
          class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
        >
          Register
        </button>

        <div class="flex items-center justify-between mt-4">
          <hr class="w-1/4 border-gray-300" />
          <span class="text-gray-500 text-sm">or sign up with</span>
          <hr class="w-1/4 border-gray-300" />
        </div>

        <div class="flex space-x-4 mt-4 justify-center">
          <button
            type="button"
            id="googleRegisterBtn"
            class="bg-white border px-4 py-2 rounded-lg shadow hover:bg-gray-100 flex items-center space-x-2"
          >
            <img
              src="https://www.svgrepo.com/show/475656/google-color.svg"
              class="w-5 h-5"
            />
            <span class="text-sm">Google</span>
          </button>
          <button
            id="linkedinRegisterBtn"
            class="w-full flex items-center justify-center gap-2 bg-[#0A66C2] text-white font-medium py-2 px-4 rounded-lg hover:bg-[#004182] transition-colors"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/>
            </svg>
            Continue with LinkedIn
          </button>
        </div>
      </form>
    </div>

    <!-- Main script -->
    <script>
      // Apply persisted theme and toggle on login page
      (function() {
        const root = document.documentElement;
        const saved = localStorage.getItem('theme') || 'light';
        root.setAttribute('data-theme', saved);
        const btn = document.getElementById('loginThemeToggle');
        function syncIcon() {
          if (!btn) return;
          const isDark = root.getAttribute('data-theme') === 'dark';
          btn.innerHTML = `<i class="fa-solid ${isDark ? 'fa-sun' : 'fa-moon'}"></i>`;
        }
        syncIcon();
        if (btn) {
          btn.addEventListener('click', function() {
            const current = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', current);
            localStorage.setItem('theme', current);
            syncIcon();
          });
        }
      })();

      window.addEventListener("DOMContentLoaded", () => {
        const HOME_URL = "index.html"; // change to "/home" if you have a home page
        const loginBtn = document.getElementById("loginBtn");
        const registerBtn = document.getElementById("registerBtn");
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const sendEmailLinkBtn = document.getElementById("sendEmailLinkBtn");
        const emailLinkInput = document.getElementById("emailLinkInput");
        const emailLinkStatus = document.getElementById("emailLinkStatus");
        const loginErrorDiv = document.getElementById("loginError");
        const googleLoginBtn = document.getElementById("googleLoginBtn");
        const googleRegisterBtn = document.getElementById("googleRegisterBtn");

        // Status helper
        function showStatus(message, type = "success") {
          if (!emailLinkStatus) return;
          emailLinkStatus.textContent = message;
          emailLinkStatus.style.display = "block";
          emailLinkStatus.className =
            type === "success"
              ? "text-green-600 text-sm mt-2 mb-2"
              : "text-red-600 text-sm mt-2 mb-2";
        }

        // Switch UI
        function showLogin() {
          loginForm.classList.remove("hidden");
          registerForm.classList.add("hidden");
          loginBtn.classList.add("bg-indigo-600", "text-white");
          registerBtn.classList.remove("bg-indigo-600", "text-white");
        }
        function showRegister() {
          registerForm.classList.remove("hidden");
          loginForm.classList.add("hidden");
          registerBtn.classList.add("bg-indigo-600", "text-white");
          loginBtn.classList.remove("bg-indigo-600", "text-white");
        }
        loginBtn.addEventListener("click", showLogin);
        registerBtn.addEventListener("click", showRegister);

        // Email link auth
        if (sendEmailLinkBtn) {
          sendEmailLinkBtn.addEventListener("click", () => {
            const email = emailLinkInput.value.trim();
            const actionCodeSettings = {
              url: window.location.origin + window.location.pathname,
              handleCodeInApp: true,
            };
            auth
              .sendSignInLinkToEmail(email, actionCodeSettings)
              .then(() => {
                window.localStorage.setItem("emailForSignIn", email);
                showStatus("Sign-in link sent! Check your email.");
              })
              .catch((error) => showStatus(error.message, "error"));
          });
        }
        if (auth.isSignInWithEmailLink(window.location.href)) {
          let email = window.localStorage.getItem("emailForSignIn");
          if (!email) email = window.prompt("Confirm your email");
          auth
            .signInWithEmailLink(email, window.location.href)
            .then(() => {
              window.localStorage.removeItem("emailForSignIn");
              window.location.href = HOME_URL;
            })
            .catch((error) => showStatus(error.message, "error"));
        }


        // Email/password login
        loginForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const email = loginForm.querySelector("#loginEmail").value;
          const password = loginForm.querySelector("#loginPassword").value;
          auth
            .signInWithEmailAndPassword(email, password)
            .then((cred) => {
              // Send login data to backend for MongoDB storage
              fetch('https://turned-trustees-components-own.trycloudflare.com/api/register',//3000
               {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  username: cred.user.displayName || cred.user.email,
                  email: cred.user.email,
                  password: 'firebase', // Not storing real password
                })
              }).finally(() => {
                window.location.href = HOME_URL;
              });
            })
            .catch((error) => {
              loginErrorDiv.textContent = error.message;
              loginErrorDiv.style.display = "block";
            });
        });

        // Registration
        registerForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const firstName = registerForm.querySelector("#registerFirstName").value;
          const lastName = registerForm.querySelector("#registerLastName").value;
          const email = registerForm.querySelector("#registerEmail").value;
          const password = registerForm.querySelector("#registerPassword").value;
          const confirmPassword = registerForm.querySelector("#registerConfirmPassword").value;
          if (password !== confirmPassword) {
            alert("Passwords do not match.");
            return;
          }
          auth
            .createUserWithEmailAndPassword(email, password)
            .then((cred) => cred.user.updateProfile({ displayName: firstName + " " + lastName }))
            .then(() => {
              // Send registration data to backend for MongoDB storage
              fetch('https://turned-trustees-components-own.trycloudflare.com/api/register',//3000
               {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  username: firstName + ' ' + lastName,
                  email: email,
                  password: 'firebase' // Not storing real password
                })
              }).finally(() => {
                window.location.href = HOME_URL;
              });
            })
            .catch((err) => alert(err.message));
        });

        // Google auth
        function handleGoogleLogin() {
          const provider = new firebase.auth.GoogleAuthProvider();
          auth
            .signInWithPopup(provider)
            .then((result) => {
              // Send Google user data to backend for MongoDB storage
              fetch('https://turned-trustees-components-own.trycloudflare.com/api/register',//3000
               {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  username: result.user.displayName || result.user.email,
                  email: result.user.email,
                  password: 'firebase-google',
                  avatarUrl: result.user.photoURL || ''
                })
              }).finally(() => {
                window.location.href = HOME_URL;
              });
            })
            .catch((err) => alert(err.message));
        }
        // LinkedIn Login Handler
        const handleLinkedInLogin = () => {
          // Generate a random state parameter for security
          const state = Math.random().toString(36).substring(2);
          localStorage.setItem('linkedin_auth_state', state);
          
          // LinkedIn OAuth2 parameters
          const params = new URLSearchParams({
            response_type: 'code',
            client_id: '86s3hqiene2q7p', // Will be replaced by server-side env var
            redirect_uri: `${window.location.origin}/auth/linkedin/callback`,
            scope: 'r_liteprofile r_emailaddress',
            state: state
          });
          
          // Redirect to LinkedIn OAuth
          window.location.href = `https://www.linkedin.com/oauth/v2/authorization?${params.toString()}`;
        };

        // Add event listeners
        googleLoginBtn.addEventListener("click", handleGoogleLogin);
        googleRegisterBtn.addEventListener("click", handleGoogleLogin);
        
        const linkedinLoginBtn = document.getElementById('linkedinLoginBtn');
        const linkedinRegisterBtn = document.getElementById('linkedinRegisterBtn');
        
        if (linkedinLoginBtn) linkedinLoginBtn.addEventListener("click", handleLinkedInLogin);
        if (linkedinRegisterBtn) linkedinRegisterBtn.addEventListener("click", handleLinkedInLogin);
      });
    </script>
    <script>
      // Handle LinkedIn custom token from URL
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('linkedin_token');
        const HOME_URL = 'index.html'; // Your home page URL

        if (token) {
          // Immediately show a loading indicator
          const loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.style.opacity = '1';
            loadingOverlay.style.visibility = 'visible';
          }

          // Sign in with the custom token
          firebase.auth().signInWithCustomToken(token)
            .then((userCredential) => {
              // User is signed in.
              console.log('Successfully signed in with LinkedIn:', userCredential.user);
              
              // Now, let's save the user data to your backend/DB
              const user = userCredential.user;
              const profileData = {
                name: user.displayName,
                email: user.email,
                provider: "linkedin",
                verified: true,
                linkedinProfile: `https://linkedin.com/in/${user.providerData[0]?.uid || ''}`,
                avatarUrl: user.photoURL
              };

              // POST to your backend to save user data
              fetch('https://turned-trustees-components-own.trycloudflare.com/api/profile', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(profileData)
              })
              .then(response => response.json())
              .then(data => console.log('Profile saved:', data))
              .catch(err => console.error('Failed to save profile:', err))
              .finally(() => {
                  // Redirect to home page after everything is done
                  window.location.href = HOME_URL;
              });
            })
            .catch((error) => {
              console.error('Error signing in with custom token:', error);
              // Optionally, show an error message to the user
              alert('Failed to sign in with LinkedIn. Please try again.');
              if (loadingOverlay) {
                  loadingOverlay.classList.add('fade-out');
              }
            });
        }
      })();

      // Hide loading overlay when page is fully loaded
      window.addEventListener('load', function() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          // Add fade-out class to start the fade-out animation
          loadingOverlay.classList.add('fade-out');
          
          // Remove the overlay from the DOM after animation completes
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500); // Match this with the CSS transition time
        }
      });

      // Show loading overlay when page is about to unload (for page transitions)
      window.addEventListener('beforeunload', function() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.classList.remove('fade-out');
          loadingOverlay.style.display = 'flex';
        }
      });
    </script>
  </body>
</html>